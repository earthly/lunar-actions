name: Sync Lunar policy
description: Instruct Lunar hub to pull manifest
author: Earthly technologies
inputs:
  manifest-url:
    description: >
      Lunar manifest repo URL, in the form of: github://<org>/<repo>@<branch>
    required: true
  hub-token:
    required: true
  lunar-version:
    description: >
      Lunar version (vx.y.z), as one of the tags available at https://github.com/earthly/lunar-dist/tags
    required: true
  hub-host:
    required: true
  hub-grpc-port:
    default: 443
    required: false
  hub-http-port:
    default: 443
    required: false
  log-level:
    description: >
      Lunar log level.
    default: debug
    required: false

runs:
  using: "composite"
  steps:
    - name: Download Lunar binary
      env:
        FORCE_COLOR: 1
      run: |
        mkdir -p /tmp/lunar/bin
        curl -L https://github.com/earthly/lunar-dist/releases/download/${{ inputs.lunar-version }}/lunar-linux-amd64 -o /usr/local/bin/lunar
        chmod +x /usr/local/bin/lunar
        echo "lunar downloaded to /tmp/lunar/bin/lunar";
      shell: bash

    - name: Pull policy
      env:
        FORCE_COLOR: 1
        LUNAR_HUB_TOKEN: ${{ inputs.hub-token }}
        LUNAR_GITHUB_TOKEN: ${{ inputs.github-token }}
        LUNAR_HUB_HOST: ${{ inputs.hub-host }}
        LUNAR_HUB_GRPC_PORT: ${{ inputs.hub-grpc-port }}
        LUNAR_HUB_HTTP_PORT: ${{ inputs.hub-http-port }}
      run: lunar hub pull -r ${{ inputs.manifest-url }}
      shell: bash

